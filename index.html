<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Blinkit AR Experience</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        :root { --accent: #4185f4; --bg-dark: #121212; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }
        .a-enter-vr, .a-enter-ar { display: none !important; }

        /* WELCOME PAGE - BOTTOM ROW LAYOUT */
        #welcome-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; background: #1a1a1a url('https://mahesh2710.github.io/ARData/target/blinkit_poster.jpg') center/cover;
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        #bottom-bar {
            width: 100%; padding: 25px 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            display: flex; justify-content: space-around; align-items: center;
        }
        .footer-text { padding-left: 20px; flex-grow: 1; }
        .footer-text h2 { color: white; margin: 0; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
        #play-button {
            margin-right: 20px; width: 120px; height: 48px; background: var(--accent);
            border: none; border-radius: 24px; cursor: pointer; color: white; font-weight: bold;
            box-shadow: 0 4px 15px rgba(65, 133, 244, 0.4); font-size: 1rem;
        }

        /* SCANNER UI */
        #scanner-ui {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10; pointer-events: none;
        }
        .scanner-frame { width: 70vw; height: 70vw; border: 2px solid rgba(255,255,255,0.2); position: relative; }
        .scanner-line { position: absolute; width: 100%; height: 3px; background: #a3ff00; top: 0; animation: scan 2s infinite linear; }
        @keyframes scan { from { top: 0; } to { top: 100%; } }

        /* SMOOTH GLOBAL VIDEO CONTAINER */
        #global-video-container {
            position: fixed; z-index: 40; pointer-events: none;
            width: 100vw; height: 100vh; top: 0; left: 0;
            display: none;
        }
        #video-element-wrapper {
            position: absolute; border: 2px solid white; border-radius: 15px; overflow: hidden;
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1); /* Ultra smooth transition */
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            background: #000;
        }
        #video-element-wrapper video { width: 100%; height: 100%; display: block; }
        
        #close-sticky {
            position: absolute; top: 10px; right: 10px; width: 30px; height: 30px;
            background: #ff3b30; color: white; border-radius: 50%; border: none;
            font-size: 18px; font-weight: bold; cursor: pointer; pointer-events: auto;
            display: none; z-index: 101;
        }

        /* PERMISSION ERROR OVERLAY */
        #permission-nag {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; padding: 30px;
        }
    </style>
</head>
<body>

    <div id="permission-nag">
        <h2>Camera Access Needed</h2>
        <p>Please allow camera permissions and refresh to start AR.</p>
        <button onclick="location.reload()" style="padding:12px 25px; border-radius:20px; border:none; background:var(--accent); color:white;">Reload</button>
    </div>

    <div id="welcome-page">
        <div id="bottom-bar">
            <div class="footer-text">
                <h2>Blinkit AR Store</h2>
            </div>
            <button id="play-button">PLAY</button>
        </div>
    </div>

    <div id="scanner-ui">
        <div class="scanner-frame"><div class="scanner-line"></div></div>
        <p style="color:white; margin-top:20px;">POINT AT PRODUCT</p>
    </div>

    <div id="global-video-container">
        <div id="video-element-wrapper">
            <button id="close-sticky">Ã—</button>
            <video id="myVideo" src="https://raw.githubusercontent.com/Mahesh2710/ARData/main/video/Gujhiya.mp4" loop crossorigin="anonymous" playsinline webkit-playsinline muted preload="auto"></video>
        </div>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: https://raw.githubusercontent.com/Mahesh2710/ARData/main/target/haldiram_new.mind; autoStart: false; uiScanning: #none;" 
        vr-mode-ui="enabled: false">
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity mindar-image-target="targetIndex: 0" id="target-entity">
            <a-text value="BLINKIT" align="center" color="#FFD700" width="4" position="0 1.2 0" font="exo2bold" negate="false"
                    animation="property: scale; to: 1.1 1.1 1.1; dir: alternate; dur: 1000; loop: true"></a-text>
            <a-plane id="video-placeholder" width="1.2" height="2.1" material="opacity: 0; transparent: true"></a-plane>
        </a-entity>
    </a-scene>

    <script>
        const video = document.getElementById('myVideo');
        const wrapper = document.getElementById('video-element-wrapper');
        const container = document.getElementById('global-video-container');
        const closeBtn = document.getElementById('close-sticky');
        const target = document.getElementById('target-entity');
        const playBtn = document.getElementById('play-button');
        const sceneEl = document.querySelector('a-scene');

        let isSticky = false;

        // Transition Logic: Moves video wrapper between AR coordinates and Screen Fixed coordinates
        const setVideoToAR = () => {
            container.style.display = 'block';
            closeBtn.style.display = 'none';
            // These values match the AR plane position
            wrapper.style.top = '50%';
            wrapper.style.left = '50%';
            wrapper.style.width = '70vw';
            wrapper.style.height = '120vw';
            wrapper.style.transform = 'translate(-50%, -50%)';
            wrapper.style.borderRadius = '15px';
            wrapper.style.opacity = '1';
        };

        const setVideoToSticky = () => {
            if (!isSticky) return;
            closeBtn.style.display = 'flex';
            wrapper.style.width = '200px';
            wrapper.style.height = '350px';
            wrapper.style.top = '20px';
            wrapper.style.left = '20px';
            wrapper.style.transform = 'translate(0, 0)';
            wrapper.style.borderRadius = '20px';
            wrapper.style.opacity = '0.9';
        };

        playBtn.addEventListener('click', () => {
            document.getElementById('welcome-page').style.display = 'none';
            document.getElementById('scanner-ui').style.display = 'flex';
            video.play().then(() => video.pause()); // Unlock iOS
            sceneEl.systems["mindar-image-system"].start();
        });

        target.addEventListener('targetFound', () => {
            isSticky = true;
            document.getElementById('scanner-ui').style.display = 'none';
            setVideoToAR();
            video.play();
        });

        target.addEventListener('targetLost', () => {
            if (isSticky) setVideoToSticky();
        });

        closeBtn.addEventListener('click', () => {
            isSticky = false;
            container.style.display = 'none';
            document.getElementById('scanner-ui').style.display = 'flex';
            video.pause();
        });
    </script>
</body>
</html>
